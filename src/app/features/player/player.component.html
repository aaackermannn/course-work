<section>
  <h2>Профиль игрока</h2>

  <tui-loader [showLoader]="loading" [overlay]="true">
    <ng-container *ngIf="!loading && player as p">
      <tui-island size="l" style="margin-bottom: 24px">
        <div class="player-hero">
          <div class="player-avatar-section">
            <div class="avatar-container">
              <img
                *ngIf="p.avatarUrl"
                [src]="p.avatarUrl"
                alt="avatar"
                class="avatar"
              />
              <div *ngIf="!p.avatarUrl" class="avatar-placeholder">
                <svg
                  width="64"
                  height="64"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </div>
            </div>
          </div>

          <div class="player-info">
            <div class="player-name-section">
              <div class="player-header">
                <h1 class="player-name">{{ p.nickname }}</h1>
                <div class="player-badges-inline">
                  <div class="country-badge-inline" *ngIf="p.country">
                    <img
                      [src]="getCountryFlag(p.country)"
                      [alt]="p.country"
                      class="flag-icon-small"
                      (error)="onImageError($event)"
                    />
                    <span>{{ p.country }}</span>
                  </div>
                  <div class="level-badge-inline" *ngIf="p.level">
                    <img
                      [src]="getLevelIcon(p.level)"
                      [alt]="'Level ' + p.level"
                      class="level-icon-small"
                      (error)="onImageError($event)"
                    />
                  </div>
                </div>
              </div>
              <div class="player-id">ID: {{ p.id }}</div>
            </div>

            <div class="action-links" style="margin-top: 8px">
              <a
                tuiButton
                size="m"
                appearance="flat"
                [routerLink]="['/matches']"
                [queryParams]="{ player: p.id }"
              >
                Матчи
              </a>
              <a
                tuiButton
                size="m"
                appearance="flat"
                [routerLink]="['/teammates']"
                [queryParams]="{ player: p.id }"
              >
                Тиммейты
              </a>
            </div>
          </div>

          <div class="player-elo" *ngIf="p.elo as elo">
            <tui-tag size="l" status="neutral">
              <strong>{{ elo }} ELO</strong>
            </tui-tag>
          </div>

          <div class="player-actions">
            <button
              *ngIf="isAuthenticated"
              tuiButton
              size="l"
              appearance="primary"
              style="min-width: auto; width: fit-content; padding: 6px 12px"
              (click)="toggleFavorite()"
            >
              {{ isFavorite ? 'Убрать из избранного' : 'Добавить в избранное' }}
            </button>
            <button
              *ngIf="!isAuthenticated"
              tuiButton
              size="l"
              appearance="flat"
              style="min-width: auto; width: fit-content; padding: 6px 12px"
              (click)="signIn()"
            >
              Войти для добавления в избранное
            </button>
          </div>
        </div>
      </tui-island>

      <div class="stats-grid">
        <tui-island size="l" class="stat-card">
          <div class="stat-header">
            <div class="stat-title">K/D Ratio</div>
          </div>
          <div class="stat-main-value">{{ p.kdRatio | number : '1.2-2' }}</div>
        </tui-island>

        <tui-island size="l" class="stat-card">
          <div class="stat-header">
            <div class="stat-title">Winrate</div>
          </div>
          <div class="stat-main-value">{{ p.winRatePercent }}%</div>
          <div class="stat-details">
            <div class="stat-row">
              <span class="stat-label">Matches:</span>
              <span class="stat-value">{{ p.matchesPlayed | number }}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Wins:</span>
              <span class="stat-value">{{
                p.wins ? (p.wins | number) : '-'
              }}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Losses:</span>
              <span class="stat-value">{{
                p.matchesPlayed - (p.wins || 0) | number
              }}</span>
            </div>
          </div>
        </tui-island>

        <tui-island size="l" class="stat-card">
          <div class="stat-header">
            <div class="stat-title">ELO</div>
          </div>
          <div class="stat-main-value">
            {{ p.elo ? (p.elo | number) : '-' }}
          </div>
        </tui-island>
      </div>
    </ng-container>

    <div *ngIf="error" class="error-message">
      <tui-island appearance="error">
        <h3 style="margin-top: 0; color: var(--danger)">
          Ошибка загрузки профиля
        </h3>
        <p>
          Не удалось загрузить данные игрока. Проверьте правильность ID или
          попробуйте позже.
        </p>
      </tui-island>
    </div>
  </tui-loader>
</section>
